---
title: "ChIP Overlap"
author: "Charlie Hale"
date: "`r Sys.Date()`"
output: html_document
---

``` {r}
library(GenomicRanges)
library(rtracklayer)
library(ggplot2)
```
Load data for TF
``` {r}
root_dir <- c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/dap/")

# Pick the TF you want to look at
#tf_name <- "ARF10"
#tf_name <- "EREB127"
#tf_name <- "BZIP72"
#tf_name <- "IG1"
tf_name <- "SBP6"

tf_dir <- paste0(root_dir, tf_name, "/", tf_name)
motif_bed <- paste0(tf_dir, "_motifs.bed")   # motif intervals
dap_bed <- c(paste0(tf_dir, "_dap.bed"))
```
Load maize intervals and import as BED
``` {r}
maize_bed <- "/workdir/coh22/poaceae_tfbs/output/feature_overlap/maize_ref/B73v5_filtered_miniprot_500up_fixedCoords.bed"   # 13k maize intervals

# Import BED files
maize <- import(maize_bed, format = "bed")
motif <- import(motif_bed, format = "bed")
dap <- import(dap_bed, format = "bed")
```


Get overlap with maize intervals for motifs and dap peaks
``` {r}
# Overlap with motif intervals
motif_hits <- findOverlaps(maize, motif)
motif_overlap <- rep(FALSE, length(maize))
motif_overlap[queryHits(motif_hits)] <- TRUE

# Overlap with dap peaks
dap_hits <- suppressWarnings(findOverlaps(maize, dap))
dap_overlap <- rep(FALSE, length(maize))
dap_overlap[queryHits(dap_hits)] <- TRUE

# Calculate the proportions
prop_motif <- mean(motif_overlap)
prop_dap  <- mean(dap_overlap)

cat("Proportion of maize intervals overlapping motif intervals:", round(prop_motif, 2), "\n")
cat("Proportion of maize intervals overlapping dap peak intervals:", round(prop_dap, 2), "\n")
```

Plot contingency matrix
``` {r}
contingency <- table(Motif = motif_overlap, dap = dap_overlap)
print(contingency)

# Convert table to data frame for plotting
contingency_df <- as.data.frame(contingency)
names(contingency_df) <- c("Motif", "dap", "Count")

# Plot the contingency matrix as a heatmap
ggplot(contingency_df, aes(x = dap, y = Motif, fill = Count)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Count), color = "white", size = 6) +
  scale_fill_gradient(low = "lightblue", high = "blue") +
  labs(title = paste("Contingency Matrix of", tf_name, "Motif presence vs dap in maize promoters"), x = "dap-seq peak", y = "Motif present")
```
Permute dap labels
``` {r}
# Observed TF overlap rate among maize intervals that have a motif
observed_overlap <- sum(motif_overlap & dap_overlap)
n_motif <- sum(motif_overlap)
observed_rate <- observed_overlap / n_motif
cat("Observed TF overlap rate among motif-overlapping maize intervals:", observed_rate, "\n")

# Set number of permutations
n_perm <- 1000
perm_rates <- numeric(n_perm)

# Permutation test: Shuffle the tf_overlap labels while keeping motif_overlap fixed.
for(i in 1:n_perm) {
  # Randomly permute the tf_overlap vector:
  permuted_tf <- sample(dap_overlap, length(dap_overlap), replace = FALSE)
  
  # Calculate the TF overlap rate with the permuted tf_overlap among intervals with a motif
  perm_overlap <- sum(motif_overlap & permuted_tf)
  perm_rates[i] <- perm_overlap / n_motif
}

# Calculate a one-sided p-value:
p_value <- sum(perm_rates >= observed_rate) / n_perm
cat("Permutation test p-value:", p_value, "\n")
df <- data.frame(perm_rate = perm_rates)

ggplot(df, aes(x = perm_rate)) +
  #geom_histogram(aes(y = ..density..), bins = 30, fill = "lightgray", color = "black") +
  geom_density(color = "blue", size = 1) +
  geom_vline(xintercept = observed_rate, color = "red", linetype = "dashed", size = 1) +
  labs(title = paste0("Permuted vs observed motif/dap overlap for ", tf_name),
       x = "% of motifs overlapping dap peaks",
       y = "Density") +
  theme_minimal() +
  xlim(c(0,1))
```
