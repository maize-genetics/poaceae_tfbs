---
title: "ChIP Overlap"
author: "Charlie Hale"
date: "`r Sys.Date()`"
output: html_document
---

``` {r}
library(GenomicRanges)
library(rtracklayer)
library(ggplot2)
```
Load data for TF
``` {r}
root_dir <- c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/")

# ereb17
#tf_name <- "ZmTF117_ereb17"
#short_tf_name <- "ereb17"

# lg2
#tf_name <- "ZmTFLG2_lg2"
#short_tf_name <- "lg2"

# glk53
tf_name <- "ZmTF58_glk53"
short_tf_name <- "glk53"

# bhlh47
#tf_name <- "ZmTF87_bhlh47"
#short_tf_name <- "bhlh47"

# hb34
#tf_name <- "ZmTF174_hb34"
#short_tf_name <- "hb34"

tf_dir <- paste0(root_dir, tf_name, "/", tf_name)
motif_bed <- paste0(tf_dir, "_motifs.bed")   # motif intervals
chip_files <- c(paste0(tf_dir, "_rep1_chip.bed"), 
                paste0(tf_dir, "_rep2_chip.bed"))
```
Load maize intervals and import as BED
``` {r}
maize_bed <- "/workdir/coh22/poaceae_tfbs/output/feature_overlap/maize_ref/B73v5_filtered_miniprot_500up_fixedCoords.bed"   # 13k maize intervals

# Import BED files
maize <- import(maize_bed, format = "bed")
motif <- import(motif_bed, format = "bed")
```

Process ChIP-seq data
``` {r}
# Function to compute consensus peaks from two replicate BED files
compute_consensus_peaks <- function(chip_rep_files) {
  rep1 <- import(chip_files[1], format = "bed")
  rep2 <- import(chip_files[2], format = "bed")
  
  # Find overlaps between the two replicates
  hits <- suppressWarnings(findOverlaps(rep1, rep2))
  
  # For each overlapping pair, compute the intersecting region
  intersections <- suppressWarnings(pintersect(rep1[queryHits(hits)], rep2[subjectHits(hits)]))
  
  # Merge any overlapping consensus intervals
  consensus <- reduce(intersections)
  return(consensus)
}

chip_consensus <- compute_consensus_peaks(chip_files)
cat("Total number of combined consensus TF peaks:", length(chip_consensus), "\n")

# Compute union
compute_union_peaks <- function(chip_rep_files) {
  rep1 <- import(chip_rep_files[1], format = "bed")
  rep2 <- import(chip_rep_files[2], format = "bed")
  
  # Combine peaks from both replicates
  combined_peaks <- c(rep1, rep2)
  
  # Merge any overlapping intervals to form the union of peaks
  union_peaks <- suppressWarnings(reduce(combined_peaks))
  
  return(union_peaks)
}
chip_union <- compute_union_peaks(chip_files)
cat("Total number of combined TF peaks:", length(chip_union), "\n")
```

Get overlap with maize intervals for motifs and chip peaks
``` {r}
# Overlap with motif intervals
motif_hits <- findOverlaps(maize, motif)
motif_overlap <- rep(FALSE, length(maize))
motif_overlap[queryHits(motif_hits)] <- TRUE

# Overlap with CHIP peaks
#chip_hits <- suppressWarnings(findOverlaps(maize, chip_consensus))
chip_hits <- suppressWarnings(findOverlaps(maize, chip_union))
chip_overlap <- rep(FALSE, length(maize))
chip_overlap[queryHits(chip_hits)] <- TRUE

# Calculate the proportions
prop_motif <- mean(motif_overlap)
prop_chip  <- mean(chip_overlap)

cat("Proportion of maize intervals overlapping motif intervals:", round(prop_motif, 2), "\n")
cat("Proportion of maize intervals overlapping ChIP peak intervals:", round(prop_chip, 2), "\n")
```

Plot contingency matrix
``` {r}
contingency <- table(Motif = motif_overlap, CHIP = chip_overlap)
print(contingency)

# Convert table to data frame for plotting
contingency_df <- as.data.frame(contingency)
names(contingency_df) <- c("Motif", "CHIP", "Count")

# Plot the contingency matrix as a heatmap
ggplot(contingency_df, aes(x = CHIP, y = Motif, fill = Count)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Count), color = "white", size = 6) +
  scale_fill_gradient(low = "lightblue", high = "blue") +
  labs(title = paste("Contingency Matrix of", short_tf_name, "Motif presence vs ChIP in maize promoters"), x = "ChIP-seq peak", y = "Motif present")
```
Permute ChIP labels
``` {r}
# Observed TF overlap rate among maize intervals that have a motif
observed_overlap <- sum(motif_overlap & chip_overlap)
n_motif <- sum(motif_overlap)
observed_rate <- observed_overlap / n_motif
cat("Observed TF overlap rate among motif-overlapping maize intervals:", observed_rate, "\n")

# Set number of permutations
n_perm <- 1000
perm_rates <- numeric(n_perm)

# Permutation test: Shuffle the tf_overlap labels while keeping motif_overlap fixed.
for(i in 1:n_perm) {
  # Randomly permute the tf_overlap vector:
  permuted_tf <- sample(chip_overlap, length(chip_overlap), replace = FALSE)
  
  # Calculate the TF overlap rate with the permuted tf_overlap among intervals with a motif
  perm_overlap <- sum(motif_overlap & permuted_tf)
  perm_rates[i] <- perm_overlap / n_motif
}

# Calculate a one-sided p-value:
p_value <- sum(perm_rates >= observed_rate) / n_perm
cat("Permutation test p-value:", p_value, "\n")
df <- data.frame(perm_rate = perm_rates)

ggplot(df, aes(x = perm_rate)) +
  #geom_histogram(aes(y = ..density..), bins = 30, fill = "lightgray", color = "black") +
  geom_density(color = "blue", size = 1) +
  geom_vline(xintercept = observed_rate, color = "red", linetype = "dashed", size = 1) +
  labs(title = paste0("Permuted vs observed motif/ChIP overlap for ", short_tf_name),
       x = "% of motifs overlapping ChIP peaks",
       y = "Density") +
  theme_minimal() +
  xlim(c(0,1))
```

# How well do ChIP intervals predict each other?
``` {r}
rep1 <- import(chip_files[1], format = "bed")
rep1_hits <- findOverlaps(maize, rep1)
rep1_overlap <- rep(FALSE, length(maize))
rep1_overlap[queryHits(rep1_hits)] <- TRUE

rep2 <- import(chip_files[2], format = "bed")
rep2_hits <- findOverlaps(maize, rep2)
rep2_overlap <- rep(FALSE, length(maize))
rep2_overlap[queryHits(rep2_hits)] <- TRUE

# Calculate the proportions
prop_rep1 <- mean(rep1_overlap)
prop_rep2  <- mean(rep2_overlap)

cat("Proportion of maize intervals overlapping rep1 intervals:", round(prop_rep1, 2), "\n")
cat("Proportion of maize intervals overlapping rep2 intervals:", round(prop_rep2, 2), "\n")

contingency <- table(Rep1 = rep1_overlap, Rep2 = rep2_overlap)
print(contingency)

# Convert table to data frame for plotting
contingency_df <- as.data.frame(contingency)
names(contingency_df) <- c("Rep1", "Rep2", "Count")

# Plot the contingency matrix as a heatmap
ggplot(contingency_df, aes(x = Rep1, y = Rep2, fill = Count)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Count), color = "white", size = 6) +
  scale_fill_gradient(low = "lightblue", high = "blue") +
  labs(title = paste("Contingency Matrix of", short_tf_name, "Rep1 vs Rep 2 ChIP-seq peak presence in maize promoters"), x = "Rep2 peak present", y = "Rep1 peak present")

# Observed TF overlap rate among maize intervals that have a motif
observed_overlap <- sum(rep1_overlap & rep2_overlap)
n_rep2 <- sum(rep2_overlap)
observed_rate <- observed_overlap / n_rep2
cat("Observed rep2 overlap rate among rep1-overlapping maize intervals:", observed_rate, "\n")

# Set number of permutations
n_perm <- 1000
perm_rates <- numeric(n_perm)

# Permutation test: Shuffle the tf_overlap labels while keeping motif_overlap fixed.
for(i in 1:n_perm) {
  # Randomly permute the tf_overlap vector:
  permuted_tf <- sample(rep2_overlap, length(rep2_overlap), replace = FALSE)
  
  # Calculate the TF overlap rate with the permuted tf_overlap among intervals with a motif
  perm_overlap <- sum(rep1_overlap & permuted_tf)
  perm_rates[i] <- perm_overlap / n_rep1
}

# Calculate a one-sided p-value:
p_value <- sum(perm_rates >= observed_rate) / n_perm
cat("Permutation test p-value:", p_value, "\n")
df <- data.frame(perm_rate = perm_rates)

ggplot(df, aes(x = perm_rate)) +
  #geom_histogram(aes(y = ..density..), bins = 30, fill = "lightgray", color = "black") +
  geom_density(color = "blue", size = 1) +
  geom_vline(xintercept = observed_rate, color = "red", linetype = "dashed", size = 1) +
  labs(title = paste0("Permuted vs observed rep1/rep2 overlap for ", short_tf_name),
       x = "% of rep1 peaks overlapping same region as rep2",
       y = "Density") +
  theme_minimal() +
  xlim(c(0,1))

```
## OLD CODE
Load motif and ChIP data for DOF TFs
``` {r}
motif_bed <- "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/B73_DOF_CDF_motifs.bed"   # motif intervals # DOF/CDF motifs

motif_bed <- "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/B73_DOF_CDF_motifs.bed" 
# ChIP-seq data
# Define a named list of TF replicate file paths
tf_files <- list(
  TF161 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF161_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF161_rep2.bed"),
  TF235 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF235_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF235_rep2.bed"),
  TF162 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF162_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF162_rep2.bed"),
  TF163 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF163_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/dof/DOF_TF163_rep2.bed")  
)
```

Load motif and ChIP data for BZIP TFs
``` {r}
motif_bed <- "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/B73_BZIP_motifs.bed" 
tf_files <- list(
  TF158 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF158_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF158_rep2.bed"),
  TF159 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF159_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF159_rep2.bed"),
  TF16 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF16_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF16_rep2.bed"),
  TF219 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF219_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF219_rep2.bed"),
  TF221 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF221_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TF221_rep2.bed"),
  TFLG2 = c("/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TFLG2_rep1.bed",
            "/workdir/coh22/poaceae_tfbs/output/feature_overlap/chip/bzip/TFLG2_rep2.bed")
)
```
Process ChIP-seq data
``` {r}
# Function to compute consensus peaks from two replicate BED files
consensus_from_reps <- function(files) {
  rep1 <- import(files[1], format = "bed")
  rep2 <- import(files[2], format = "bed")
  
  # Find overlaps between the two replicates
  hits <- suppressWarnings(findOverlaps(rep1, rep2))
  
  # For each overlapping pair, compute the intersecting region
  intersections <- suppressWarnings(pintersect(rep1[queryHits(hits)], rep2[subjectHits(hits)]))
  
  # Merge any overlapping consensus intervals
  consensus <- reduce(intersections)
  return(consensus)
}

# Compute consensus peaks for each TF
tf_consensus_list <- lapply(tf_files, consensus_from_reps)

# Combine consensus peaks from all TFs into one GRanges object.
# This means if any TF has a peak in a region, it will be included.
all_tf_consensus <- reduce(unlist(GRangesList(tf_consensus_list)))
cat("Total number of combined consensus TF peaks:", length(all_tf_consensus), "\n")
```